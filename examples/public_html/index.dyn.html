<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="/assets/style.css" rel="stylesheet">
</head>
<body>
    <h1>Hello, <?lu write(query.name or "Nomad") ?></h1>
    <h2>Welcome to 80's HTTP server!</h2>
    <img src="/assets/srgen.jpg">
    <p>w3.org response:</p>
    <pre><?lua
        header("X-Server-Time", os.time())
        function GET(host, script, accept)
            local sock, err = aio:connect(ELFD, host, 80)
            if sock then
                -- coroutinized version
                aio:cor1(sock, "on_connect", function(_, done)
                    sock:write(
                        string.format(
                            "GET %s HTTP/1.1\r\nHost: %s\r\nAccept: %s\r\nConnection: close\r\n\r\n", 
                            script,
                            host,
                            accept
                        )
                    )
                    done(true)
                end)

                return aio:cor(sock, function(stream, done)
                    local data = ""
                    for chunk in stream do
                        data = data .. chunk
                        coroutine.yield()
                    end
                    done(data)
                end)
            else
                return function(done)
                    done("Failed to open socket")
                end
            end
        end
        GET("www.w3.org", "/", "text/html")(function(response)
            write(response)
            done()
        end)
    ?></pre>
</body>
</html>